\section{Lower bound $\Omega(\ell)$}

\maciek{I assume $\alpha = 1$ to simplify calculations, but everything should hold for general $\alpha$}

Model assumes the existence of a perfect partition of the input graph.
We present a lower bound for the competitive ratio of $\Omega(\ell)$ for any deterministic algorithm.
To this end, we use $k = 3$, i.e., the capacity of each server is $3$.


\begin{theorem}
  The competitive ratio of any deterministic algorithm for Online Balanced Partition (assuming the existence of a perfect partition of the input graph) is $\Omega(\ell)$.
  \label{th:lb_omega_l}
\end{theorem}
%Note that in the scenario with a perfect partition, both OPT and ALG always pays at most $O(\ell)$.

\begin{proof}
We say that nodes that belong to the same cluster in the initial configuration \emph{have the same color}.

Consider clusters $A$ and $B$ containing nodes $a_1, a_2, a_3$ and $b_1, b_2, b_3$, respectively.
The adversary begins with issuing three requests: $(a_1, a_2)$, $(b_1, b_2)$, and $(a_3, b_3)$.
Note that the algorithm is forced to move at least one of these components to a third cluster:
in general, if the algorithm does not keep each component within one cluster, the adversary might continue issuing requests among nodes of this component.



The algorithm places these three components in different clusters, and for this it pays at least $2$.
By $x$ (resp. $y$) we denote the third node from the cluster containing the component $(a_1, a_2)$ (resp. $(b_1, b_2)$).
%These nodes $x$ and $y$ are of the algorithm's choice, but.
During the execution of the algorithm, these nodes change, and by $x$ and $y$ we always denote the current nodes of the algorithm colocated with components $(a_1, a_2)$ and $(b_1, b_2)$.

%Let's call the cluster of $(a_1, a_2)$ the cluster $A_{ALG}$, the cluster of $(b_1, b_2)$ the cluster $B_{ALG}$ and the cluster of $(a_3, b_3)$ the cluster $C$. The configuration of ALG's clusters is then: $A_{ALG}$ contains $a_1, a_2,x$, the cluster $B_{ALG}$ contains $b_1, b_2,y$ and the cluster $C$ contains $a_3, b_3, z$, for some $x, y, z$ (of the algorithm's choice).

Our idea is that OPT pays for the request $(a_3, b_3)$ only (i.e., it moves this pair to a carefuly chosen cluster that we denote by $D$), and for OPT all other requests are free. 
OPT places these three components in clusters $A, B$ and $D$, paying $2$ for migrating $a_3$ and $b_3$.
The configuration of OPT's clusters is then: $A$ contains $a_1, a_2,d_1$, $B$ contains $b_1, b_2,d_2$ and $D$ contains $a_3, b_3, d_3$.
Note that the requests between nodes of the same color are free for OPT, with the exception of nodes from $A$, $B$, and most notably $D$.

OPT has the freedom of choice of the cluster $D$ depending on the choices of the algorithm.
We choose $D$ in such way that initially it does not contain neither $x$ nor $y$, and furthermore that the algorithm places any of nodes from $D$ at $x$'s or $y$'s place as the last possible move.
In other words, we inspect the sequence of $x$ and $y$ of the algorithm, and we choose $D$ to be the last cluster whose initial contents appears as the $x$ and $y$.
As there are $\ell$ clusters to choose from, ALG has to serve at least $\Omega(\ell)$ requests before any of $D$'s contents appear as $x$ or $y$.

From this point, OPT does not change its configuration, and the adversary continues to issue a request between $x$ and any other node with the same color as $x$
(note that by $x$ we might denote different node in every iteration, as $x$ is defined as a node colocated with a component $(a_1, a_2)$).
Upon receiving this request, ALG pays for it the cost at least $1$ and it increases its number of clusters that contain non-singleton components by $1$.
This procedure ends when ALG has no more clusters with singleton-only components left or ALG manages to put $d_1, d_2$ or $d_3$ in place of either $x$ or $y$.

At the begining, ALG has $\ell$ singleton-only components and each request increases their number by $1$.
Furthermore, before reaching either $d_1, d_2$ or $d_3$ in place of either $x$ or $y$, the algorithm must cycle through $\Omega(\ell)$ nodes from other clusters. This can be guaranteed as the choice of $D$ can depend on the actions of the deterministic algorithm.
In total, OPT pays $2$, and moreover ALG pays $\Omega(\ell)$, as it peforms a migration of two nodes for each request besides the first two.


%The next action of the adversary depends on the choice of $x, y, z$.
%If $x$ and $y$ have different color (i.e., initially they belong to different clusters), then we issue a request between $x$ and any other node with the same color as $x$. As $x$ do not intersect with $D$, the OPT has them co-located in one server, and it pays no cost for such requests. We issue such requests until $x$ and $y$ have the same color.

%Note that the adversary can foresee the actions of the algorithm, and may choose $D$ in such way, that $x$ cycles through all other clusters before reaching $D$, paying the cost of $\Omega(k)$, which would already suffice to show the lower bound.

%Then, $x$ and $y$ have the same color, and we issue a request $(x, y)$. As these have the same color (and there are different than $d_1, d_2$ and $d_3$), OPT pays no cost for this request, and ALG pays $2$ for migrating $x$ and $y$ to other cluster.
%We repeat the entire process, i.e., we force ALG to choose $x$ and $y$ of the same color, and issue such request that is free for OPT. This process can continue until ALG has no more clusters with singleton components, or it pays the cost $\Omega(k)$ already.

\end{proof}

\begin{observation}
  The lower bound of $\Omega(\ell)$ can be generalized for arbitrary $k = c\cdot 3$.
  The adversary starts with a serie of ``glueing requests'', so that each cluster contains 3 components of size $k/3$.
  We repeat the argument of Theorem~\ref{th:lb_omega_l} using these glued components instead of singletons.
  OPT pays $O(k)$ for migration of one such component, and ALG pays $\Omega(k \cdot \ell)$.
  \label{obs:lb_general_k}
\end{observation}

\begin{observation}
  The lower bound of $\Omega(\ell)$ holds even with $1/3-1/k$-augmentation, i.e., in scenarios where the capacity of each cluster of the algorithm is $(1+1/3)\cdot k - 1$, while the capacity of OPT's clusters is $k$.
  To this end we use the construction from Observation~\ref{obs:lb_general_k}.
  We observe that each cluster of the algorithm can fit exactly $3$ components of size $k/3$.
  \maciek{Note that this does not contradict the existence of $O((1+1/\epsilon)\cdot k \cdot \log(k))$ algorithm of Avin, Bienkowski et al, as it requires $2+\epsilon$-augmentation.}
\end{observation}

\section{An $O(\ell)$-competitive algorithm for $k=3$}

\begin{theorem}
  The rebalancing cost for the greedy algorithm for $k=3$ is $O(1)$.
  \maciek{Greedy = find the cheapest feasible partition}
  \label{rebalancing-cost}
\end{theorem}

\begin{proof} 
 \maciek{Note: we consider a cost of cheapest feasible rebalancing after insertion of one edge. This in contrast to bounding the distance between any two reconfigurations (this theorem does not bound the latter).}
  
  We distinguish among three configuration types of algorithm's clusters: $C_1, C_2, C_3$. In $C_1$ we have $3$ singleton components (this is also the initial configuration of any cluster). In $C_2$ we have one component of size $2$ and one component of size $1$. Finally, in $C_3$ we have one component of size $3$.

  Consider a request $(u, v)$ and let $U, V$ be their clusters.
  If $U=V$, then the request does not require a reconfiguration.
  Now, we consider cases upon the type of clusters $U$ and $V$.
  Note that this is impossible that either $U$ or $V$ is $C_3$ as otherwise the resulting component would have the size $4$, and this contradicts the existence of the perfect partition.
  If either $U$ or $V$ is $C_1$, then either cluster can fit the merged component, and the rebalance is local within $U$ and $V$, for the cost of at most $3$ migrations.

  Now, we focus on the case where both $U$ and $V$ are $C_2$. Note that $(u,v)$ cannot both belong to a component of size $2$, as the merged component would have size $4$.
  If either $u$ or $v$ belongs to a component of size $2$ then it suffices to exchange components of size $1$ between $U$ and $V$.
  Finally, if $u$ and $v$ belong to components of size $1$, then we must place them in a cluster different from $U$ and $V$.
  Note that in such case, a $C_1$-type cluster exists, as otherwise the input graph would not have a perfect partition. The cost of rebalancing is then at most $12$ \maciek{can show smaller constant than 12, but it does not matter that much}.
\end{proof}

\begin{theorem}
  There exists a $O(\ell)$-competitive algorithm for $k=3$.
\end{theorem}

\begin{proof}
  The adversary issues at most $3\ell$ requests, as otherwise the perfect partition would not exist. Each request issues at most one rebalancingfor the greedy algorithm, and by Theorem~\ref{rebalancing-cost}, the total cost of any algorithm is $O(k\cdot \ell)$.
\end{proof}